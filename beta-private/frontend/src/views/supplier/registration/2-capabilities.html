{{> errors}}

<header class="page-main-heading">
  <h1>{{t 'Onboarding.Capabilities.Title' }}</h1>
  <h2>{{t 'Onboarding.Capabilities.Subtitle'}}</h2>
</header>

<section class="preamble">
  {{#each (tt 'Onboarding.Capabilities.Preamble')}}
  <p>{{{.}}}</p>
  {{/each}}
</section>

{{#> help-reveal
  title='Onboarding.Capabilities.Help.Title'}}
  {{#each (tt 'Onboarding.Capabilities.Help.Text')}}
    <p>{{{.}}}</p>
  {{/each}}
{{/help-reveal}}

{{#> form form_id=activeFormId}}
  <fieldset id="capabilities-core">
    <legend>{{t 'Onboarding.Capabilities.Fieldsets.Core.Legend'}}</legend>
    <ul>
      {{#capabilitiesByGroup.core}}
        {{> selectable-capability}}
      {{/capabilitiesByGroup.core}}
    </ul>
  </fieldset>
  <fieldset id="capabilities-non-core">
    <legend>{{t 'Onboarding.Capabilities.Fieldsets.NonCore.Legend'}}</legend>
    <ul>
      {{#capabilitiesByGroup.noncore}}
        {{> selectable-capability}}
      {{/capabilitiesByGroup.noncore}}
    </ul>
  </fieldset>

  <input type="submit"
    class="button primary"
    name="action[continue]"
    value="{{t 'Buttons.Save and continue'}}">
{{/form}}
<a class="back-link" href="../">{{t 'Onboarding.Capabilities.Backlink.Title'}}</a>

<div id="capability-summary">
  <section class="capabilities">
    <h2>
      <span class="capability-count plural">
        <span class="counter">0</span>
        <span class="singular">{{t 'Onboarding.Capabilities.Summary.Counter.Capability.Singular'}}</span>
        <span class="plural">{{t 'Onboarding.Capabilities.Summary.Counter.Capability.Plural'}}</span>
      </span>
    </h2>
    <ul class="capabilities">
      {{#capabilities}}
      <li data-id="{{id}}"><a href="{{url}}" target="_blank">{{name}}</a></li>
      {{/capabilities}}
    </ul>
  </section>
  <section class="standards" data-base-std-count="{{standardsByGroup.overarching.length}}">
    <h2>
      <span class="standard-count plural">
        <span class="counter">{{standardsByGroup.overarching.length}}</span>
        <span class="singular">{{t 'Onboarding.Capabilities.Summary.Counter.Standard.Singular'}}</span>
        <span class="plural">{{t 'Onboarding.Capabilities.Summary.Counter.Standard.Plural'}}</span>
      </span>
    </h2>
    <section class="associated">
      <h3>{{t 'Onboarding.Capabilities.Summary.Standards.Associated.Heading'}}</h3>
      <ul>
        {{#standardsByGroup.associated}}
        <li data-id="{{id}}" class="selected"><a href="{{url}}" target="_blank">{{name}}</a></li>
        {{/standardsByGroup.associated}}
      </ul>
    </section>
    <section class="overarching">
      <h3>{{t 'Onboarding.Capabilities.Summary.Standards.Overarching.Heading'}}</h3>
      <ul>
        {{#standardsByGroup.overarching}}
        <li data-id="{{id}}" class="selected"><a href="{{url}}" target="_blank">{{name}}</a></li>
        {{/standardsByGroup.overarching}}
      </ul>
    </section>
  </section>
</div>

<script type="text/javascript">
/* global $, $$ */
'use strict'

document.addEventListener('DOMContentLoaded', function () {
  // utility functions in place of inline arrow lambdas
  function nonEmptyItems (item) { return !!item }
  function idFromDataset (el) { return el.dataset.id }
  function standardsIdsFromDataset (el) { return el.dataset.stdIds }
  function toggleSelected (el, force) { el.classList.toggle('selected', force) }
  function splitOnCommas (str) { return str.split(',') }
  function concatAll (acc, val) { return acc.concat(val) }

  function updateCounter (elCounterSection, count) {
    count = +count
    $('.counter', elCounterSection).innerText = count
    elCounterSection.classList.toggle('singular', count === 1)
    elCounterSection.classList.toggle('plural', count !== 1)
  }

  function updateSummary () {
    const selectedCapabilities = $$('[type=checkbox][name^=capabilities][data-id]:checked')

    // update the capability count and plurality
    updateCounter($('#capability-summary .capability-count'), selectedCapabilities.length)

    // set selected class on all selected capabilities in summary
    const elCapabilityList = $('#capability-summary .capabilities')
    const selectedCapabilityIds = selectedCapabilities.map(idFromDataset)
    $$('[data-id]', elCapabilityList).forEach(function (el) {
      toggleSelected(el, selectedCapabilityIds.includes(idFromDataset(el)))
    })

    // generate the list of associated standards for all selected capabilities
    const assocStdIds = selectedCapabilities.map(standardsIdsFromDataset)
      .filter(nonEmptyItems)
      .map(splitOnCommas)
      .reduce(concatAll, [])

    // hide all the associated standards and their section
    const elStandardsSection = $('#capability-summary .standards')
    const baseStdCount = +elStandardsSection.dataset.baseStdCount
    let assocStdCount = 0
    const stdIdToAssocStdEl = {}

    $$('.associated, .associated [data-id]', elStandardsSection).forEach(function (el) {
      el.classList.remove('selected')
      if (el.dataset.id) {
        stdIdToAssocStdEl[el.dataset.id] = el
      }
    })

    // show only the standards associated with the selected capabilities
    assocStdIds.forEach(function (stdId) {
      stdIdToAssocStdEl[stdId].classList.add('selected')
      assocStdCount++
    })

    // update the standards required count, taking the overarching standards into account
    if (assocStdCount) {
      $('.associated', elStandardsSection).classList.add('selected')
    }
    updateCounter($('#capability-summary .standard-count'), baseStdCount + assocStdCount)
  }

  $('#content form').addEventListener('change', updateSummary)
  updateSummary()
})
</script>
