<div id="assessment">
  {{> onboarding-progress-header
        title="Enter Capabilities Assessment Evidence"
        subtitle="Stage 2—Capabilities Assessment"}}

  {{> solution-info solution}}

  <div class="help">
    <p>For each Capability below, review the guidelines.
       Then, provide a link to a video as evidence demonstrating how your solution
       meets the guidelines for each capability. The video <strong>must be downloadable</strong> from the link provided.</p>

    <p>If your solution passes the Capabilities Assessment and Standards
       Compliance (Stages 2 &amp; 3), the videos shared on this page will be used as
       part of the content on your solution’s catalogue page, which will be
       displayed to buyers.</p>

    <p>If you don’t want a video displayed to buyers, you can suppress it before
       you publish during the final stage of the onboarding journey &mdash; Solution Page.</p>
  </div>

  <form method="post">
    {{#solution.capabilities}}
    <fieldset id="evidence-{{id}}" class="capability {{statusClass}}">
      <legend>{{ name }} <span class="status">{{status}}</span></legend>
      <p class="description">{{ description }}</p>
      <a href="{{ url }}" target="_blank">View full Capability description & Capability Standards.</a>
      <h3>Evidence Guidelines</h3>
      {{#with (lookup ../questions id)}}
      <fieldset class="evidence">
        <p>{{lede}}</p>
        <ul>
          {{#points}}
          <li>{{.}}</li>
          {{/points}}
        </ul>
        <input type="text"
               name="evidence[{{../id}}]"
               value="{{../evidence}}"
               placeholder="Provide link to downloadable video">
        <a class="evidenceLink" target="_blank" href="{{../evidence}}">{{../evidence}}</a>
      </fieldset>
      {{/with}}
      <div class="controls editing">
        <input class="button" type="submit" name="save[{{id}}]" value="Save">
        <span>By saving this link, you are confirming that your solution can meet this capability to the best of your knowledge.</span>
      </div>
      <div class="controls">
        <a class="edit button">Edit</a>
      </div>
      <div class="remove">
        <a class="remove-capability"
            href="#"
            title="If you don’t feel that you can provide evidence demonstrating how your solution meets this capability, then you can remove it.">remove capability</a>
      </div>
    </fieldset>
    {{/solution.capabilities}}
    <div class="messaging">
      <h3>Assessment Messaging (optional)</h3>
      <p class="help">Add any general comments that you would like to include with your submission. Please note that comments will not be assessed by the Capability Assessment team.</p>
      <textarea name="message" rows="6"></textarea>
    </div>
    <div class="controls">
        <button name="action" value="save" type="submit">Save</button>
        <button class="primary" name="action" value="submit" type="submit">Submit</button>
        <input type="hidden" name="_csrf" value="{{csrfToken}}">
    </div>
  </form>
  {{#if messages}}
  <section class="message-history">
    <h3>Assessment Message History</h3>
    <ul class="messages">
    {{#messages}}
      <li class="message {{originatorClass}}">
        <pre class="text">{{message}}</pre>
        <p class="metadata">
          <span class="originator">{{contact.firstName}} {{contact.lastName}}</span>
          <span class="timestamp">{{displayTimestamp}}</span>
        </p>
      </li>
    {{/messages}}
    </ul>
  </section>
  {{/if}}
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('fieldset.capability > legend').forEach(el => {
    el.addEventListener('click', toggleFieldsetCollapse)
  })

  document.querySelectorAll('fieldset.capability .edit.button').forEach(el => {
    el.addEventListener('click', toggleFieldsetEditing)
  })

  $$('a.remove-capability').forEach(el => {
    el.addEventListener('click', ev => {
      const elCap = ev.target.closest('fieldset.capability')
      elCap.parentElement.removeChild(elCap)
    })
  })

  function toggleFieldsetCollapse (ev) {
    ev.target.closest('fieldset').classList.toggle('expanded')
  }

  function toggleFieldsetEditing (ev) {
    ev.target.closest('fieldset.capability').classList.toggle('editing')
  }
})
</script>
