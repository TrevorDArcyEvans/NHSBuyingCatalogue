<div id="add-edit-solution" class="supplier">
  {{> onboarding-progress-header
        title="Select Capabilities"
        subtitle="Register Solution (2 of 4)"}}
  <h3 class="question">Which Capability(-ies) does your Solution provide?</h3>
  <p>Select all that apply.</p>
  <p class="commercial-warning">
    <strong>Commercial Warning</strong>
    You must select ALL the Capabilities your Solution provides. If your Solution provides Capabilities that are not outlined below, please {info on this to come}.
  </p>
  {{#> help-reveal title="Help - What are Capabilities?"}}
    <p>Capabilities describe what your Solution does. Your Solution will be assessed against the Capabilities that it provides to ensure that it is within the scope of the Catalogue.
      <a href="{{capabilitiesHelpUrl}}" target="_blank">Learn more and view all Capabilities &amp; Standards.</a>
    </p>
  {{/help-reveal}}

  {{#errors}}
  <p class="error">{{.}}</p>
  {{/errors}}
  <form method="post" novalidate>
    {{#each groupedCapabilities as |capabilities group|}}
    <fieldset class="capability-group">
      <legend>{{group}}</legend>
      <ul class="capabilities">
        {{#capabilities}}
        <li class="capability {{types}}" data-cap-id="{{id}}" data-std-ids="{{standardIds}}">
          <h4 class="name">{{name}}</h4>
          <input id="select-capability-{{id}}" type="checkbox" name="capabilities" value="{{id}}"{{#selected}} checked{{/selected}}>
          <section class="reveal">
            <p class="description">
              {{description}}
              {{#url}}
                <a href="{{.}}" target="_blank">See full Capability description</a>
              {{/url}}
            </p>
            <section class="standards">
              <p>To comply with this Capability, you will have to meet these associated Standards.</p>
              {{#if standards.mandatory}}
              <section class="mandatory">
                <ul>
                  {{#standards.mandatory}}
                  <li><a href="{{url}}" target="_blank">{{name}}</a></li>
                  {{/standards.mandatory}}
                </ul>
              </section>
              {{/if}}
              {{#if standards.interop}}
              <section class="interop">
                <p>Interoperability</p>
                <ul>
                  {{#standards.interop}}
                  <li><a href="{{url}}" target="_blank">{{name}}</a></li>
                  {{/standards.interop}}
                </ul>
              </section>
              {{/if}}
            </section>
            <p>By selecting this Capability, I acknowledge the set of standards my solution must meet to attain compliance with this Capability.</p>
            <label for="select-capability-{{id}}" class="unchecked button primary">Select</label>
            <label for="select-capability-{{id}}" class="checked">
              <span class="selected">✔︎ Selected</span>
              <span class="remove">Remove selection</span>
            </label>
          </section>
        </li>
        {{/capabilities}}
      </ul>
    {{/each}}
    </fieldset>
    <section class="summary">
      <header>
        <h3>Summary</h3>
      </header>
      <section class="capabilities">
        <p class="counter"><span class="count"></span> selected</p>
        <details>
          <summary>Capabilities</summary>
          <ul>
            {{#capabilities}}
            <li data-cap-id="{{id}}">
              {{name}}
            </li>
            {{/capabilities}}
          </ul>
        </details>
      </section>
      <section class="standards">
        <p class="counter">Compliance with <span class="count"></span> will be required</p>
        <ul>
          <li class="group">
            <details>
              <summary>Capability-specific Standards</summary>
              <ul>
                {{#standards.mandatory}}
                <li data-std-id="{{id}}"><a target="_blank" href="{{url}}">{{name}}</a></li>
                {{/standards.mandatory}}
              </ul>
            </details>
          </li>
          <li class="group">
            <details>
              <summary>Solution-specific Standards</summary>
              <ul>
                {{#standards.interop}}
                <li data-std-id="{{id}}"><a target="_blank" href="{{url}}">{{name}}</a></li>
                {{/standards.interop}}
              </ul>
            </details>
          </li>
          <li class="group">
            <details>
              <summary>General Standards</summary>
              <ul>
                {{#standards.overarching}}
                <li data-std-id="{{id}}"><a target="_blank" href="{{url}}">{{name}}</a></li>
                {{/standards.overarching}}
              </ul>
            </details>
          </li>
        </ul>
      </section>
    </section>

    <fieldset class="controls">
      <button name="action" value="save" type="submit">Save</button>
      <button class="primary" name="action" value="submit" type="submit">Continue</button>
      <input type="hidden" name="_csrf" value="{{csrfToken}}">
    </fieldset>
  </form>
</div>

<script>
/* global $, $$ */
document.addEventListener('DOMContentLoaded', () => {
  function updateForCapabilitySelectionStateChange () {
    function select (el) {
      el.classList.add('selected')
    }

    function deselect (el) {
      el.classList.remove('selected')
    }

    // reset all selected states
    const mainCapabilities = $$(
      '#add-edit-solution ul.capabilities input[name=capabilities]'
    )
    mainCapabilities.forEach(el => deselect(el.closest('.capability')))

    const summaryCapabilities = {}
    $$(
      '#add-edit-solution .summary .capabilities [data-cap-id]'
    ).forEach(el => {
      deselect(el)
      $$('.optional', el).forEach(deselect)
      summaryCapabilities[el.dataset.capId] = el
    })

    const summaryStandards = {}
    $$(
      '#add-edit-solution .summary .standards [data-std-id]'
    ).forEach(el => {
      deselect(el)
      summaryStandards[el.dataset.stdId] = el
    })

    const standardGroups = $$(`
      #add-edit-solution .summary .standards li.group,
      #add-edit-solution .summary .capabilities details`)
    standardGroups.forEach(deselect)

    let capabilityCount = 0
    let standardCount = 0

    mainCapabilities.forEach(elCheckbox => {
      const elCapability = elCheckbox.closest('.capability')
      if (elCheckbox.checked) {
        capabilityCount += 1
        select(elCapability)

        const capabilityId = elCapability.dataset.capId
        const elSummaryCapability = summaryCapabilities[capabilityId]
        select(elSummaryCapability)

        $$(
          'input[type=checkbox][name^=optionalStandards]',
          elCapability
        ).forEach(elOptionalStandardCheckbox => {
          if (elOptionalStandardCheckbox.checked) {
            const standardId = elOptionalStandardCheckbox.value
            select($(`.optional[data-std-id=${standardId}]`, elSummaryCapability))
          }
        })

        const standardIds = elCapability.dataset.stdIds.split(',')
        standardIds.forEach(stdId => {
          const elStd = summaryStandards[stdId]
          if (elStd && !elStd.classList.contains('selected')) {
            standardCount += 1
            select(summaryStandards[stdId])
          }
        })
      }
    })

    // make any groups visible that have selected standards within them
    standardGroups.forEach(el => {
      if (el.querySelector('.selected')) {
        select(el)
      }
    })

    // update the counters
    $('#add-edit-solution .summary .capabilities .count').innerText =
      capabilityCount + (capabilityCount !== 1 ? ' capabilities' : ' capability')
    $('#add-edit-solution .summary .standards .count').innerText =
      standardCount + (standardCount !== 1 ? ' standards' : ' standard')

    // only allow form submission if at least one capability is selected
    $('#add-edit-solution .controls [name=action][value=submit]').disabled = !capabilityCount
  }

  // initial synchronisation of capability selected states
  updateForCapabilitySelectionStateChange()

  $$('.capability-group').forEach(el => {
    el.addEventListener('change', updateForCapabilitySelectionStateChange)
  })
})
</script>
